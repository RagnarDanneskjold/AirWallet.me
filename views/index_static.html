{{#def.loadfile('/views/header.html')}}
<div id="content">Loading...</div>
<script src="{{=it.source_base}}/static/js/async.js" type="text/javascript"></script>
<script type="text/javascript">
{{#def.loadfile('/views/index.js')}}
</script>
<script type="text/javascript">
  var current_currency;
  var query_api = function(request,cb){
    var payload = {'method': request['method'], 'id': 1, 'jsonrpc': 1, 'params': request['params']};
    $.post('https://bkchain.org/api/raw/' + request['currency'], JSON.stringify(payload), function(body){
      cb(null, body);
    });
  };
  
  // Get templates (generated by doT.js)
  var navbarTemplate = {{#def.loadfile('/views/navbar_template.js')}};
  var indexTemplate = {{#def.loadfile('/views/index_template.js')}};
  var blockTemplate = {{#def.loadfile('/views/block_template.js')}};
  var transactionTemplate = {{#def.loadfile('/views/tx_template.js')}};
  var addressTemplate = {{#def.loadfile('/views/address_template.js')}};
  
  // Check for hash change (cross-browser solution)
  if ("onhashchange" in window) { // event supported?
      window.onhashchange = function () {
          hashChanged(window.location.hash);
      }
  }
  else { // event not supported:
      var storedHash = window.location.hash;
      window.setInterval(function () {
              storedHash = window.location.hash;
          if (window.location.hash != storedHash) {
              hashChanged(storedHash);
          }
      }, 100);
  }
  
  {{#def.loadfile('/views/router.js')}}
  
  // Initial change
  hashChanged(window.location.hash);

  function main_search() {
    route_search(current_currency, $('#search').val(), function(location) { window.location.hash = '/' + location; });
  }
  
  function hashChanged(url) {
    // Close web socket (if any was still running)
    closeLiveIndex();
    
    var url = window.location.hash;
    var url_parts = url.split('/');
    
    url_parts.shift();
    
    var data = {
      script_name_base: '#'
    };
    
    route_prepare_data(data, '#/', url_parts);
    // Update navbar and title
    document.getElementById('navbar_content').innerHTML = navbarTemplate(data);
    document.title = data['currency'] + ' ' + data['title_details'];

    // Update currency
    current_currency = data['currency_api'];
    
    route_url(data, url_parts, function(request_type, data) {
      if (request_type == 'index') {
        $('#content').html(indexTemplate(data));
        setupLiveIndex(data);
      } else if (request_type == 'block') {
        $('#content').html(blockTemplate(data));
      } else if (request_type == 'tx') {
        $('#content').html(transactionTemplate(data));
      } else if (request_type == 'address') {
        $('#content').html(addressTemplate(data));
        var keyValuePair = {};
        keyValuePair["qrcode_public"] = data.address.addr;
        ninja.qrCode.showQrCode(keyValuePair, 5);
      } else if (request_type == 'error') {
        $('#content').html('<div class="alert ' + alertType + ' alert-dismissable">'
         + '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'
         + data['message']
         + '</div>');
      }
      // Scroll to top
      document.body.scrollTop = document.documentElement.scrollTop = 0;
      
      // Update timeago
      $("abbr.timeago").timeago();
    }, function(location) { window.location.hash = '/' + location; }
    );
  }
  
</script>
{{#def.loadfile('/views/footer.html')}}